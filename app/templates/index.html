<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project: Paper Trail - Politician Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .chart-container {
            position: relative;
            margin: auto;
            height: 300px;
            width: 100%;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1F2937;
        }

        /* bg-gray-800 */
        ::-webkit-scrollbar-thumb {
            background: #4B5563;
            border-radius: 4px;
        }

        /* bg-gray-600 */
        ::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
        }

        /* bg-gray-500 */
        /* Selected radio button label */
        .filter-radio:checked+label {
            background-color: #DC2626;
            /* red-600 */
            border-color: #DC2626;
            /* red-600 */
            color: white;
            font-weight: 600;
        }

        /* Disabled pagination buttons */
        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .subject-tags {
            margin-top: 8px;
        }

        .subject-tag {
            background-color: #007bff;
            /* Initial color for tags */
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 5px;
            cursor: pointer;
            display: inline-block;
            margin-top: 5px;
            transition: background-color 0.2s;
        }

        .subject-tag:hover {
            background-color: #0056b3;
        }

        /* Selected subject tag */
        .subject-tag.bg-red-700 {
            background-color: #B91C1C;
        }

        /* red-700 */
        .subject-tag.bg-gray-600 {
            background-color: #4B5563;
        }

        /* Default gray */

        #donationChartTitle {
            cursor: pointer;
            user-select: none;
        }

        #donationChartTitle:hover {
            opacity: 0.7;
        }

        /* Dropdown Styles */
        .form-checkbox {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding: 0;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            display: inline-block;
            vertical-align: middle;
            background-origin: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            flex-shrink: 0;
            height: 1rem;
            width: 1rem;
            color: #DC2626;
            /* red-600 */
            background-color: #374151;
            /* gray-700 */
            border-color: #4B5563;
            /* gray-600 */
            border-width: 1px;
            border-radius: 0.25rem;
        }

        .form-checkbox:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
            border-color: transparent;
            background-color: currentColor;
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
        }

        .dropdown-menu::-webkit-scrollbar {
            width: 6px;
        }

        .dropdown-menu::-webkit-scrollbar-track {
            background: #1F2937;
        }

        .dropdown-menu::-webkit-scrollbar-thumb {
            background: #4B5563;
            border-radius: 3px;
        }

        .dropdown-menu::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <div class="flex items-center justify-center gap-4 mb-2">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1e/The_Young_Turks_logo.svg/200px-The_Young_Turks_logo.svg.png"
                    alt="TYT Logo" class="h-12 w-12 md:h-16 md:w-16" onerror="this.style.display='none'">
                <h1 class="text-4xl md:text-5xl font-bold text-white">Project: Paper Trail</h1>
            </div>
            <p class="text-lg text-gray-400">A Crowdsourcing Project </p>
            <!-- New Disclaimer -->
            <div
                class="mt-6 p-4 bg-yellow-900/50 border border-yellow-700 rounded-lg text-center text-yellow-300 text-sm max-w-2xl mx-auto">
                <p><strong class="font-semibold text-yellow-200">Disclaimer:</strong> This site is currently in its
                    early stages. More data is actively being added, and you may encounter bugs. Thank you for your
                    patience!</p>
            </div>
            <!-- End Disclaimer -->
            <nav class="mt-4 text-lg">
                <a href="/" class="text-white font-semibold hover:underline mx-2">Politician Search</a>
                <span class="text-gray-500">|</span>
                <a href="/donor_search.html" class="text-red-500 hover:underline mx-2">Donor Search</a>

            </nav>

        </header>

        <div id="searchSection" class="bg-gray-800 border border-gray-700 p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-center text-white leading-tight">
                Search for a Congressperson <br>
                <span class="text-lg font-normal text-gray-400">(2003-Present)</span>
            </h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="searchInput" placeholder="Enter name"
                    class="flex-grow p-3 bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-2 focus:ring-red-500 focus:outline-none transition">
                <button id="searchButton"
                    class="bg-red-600 text-white font-semibold p-3 rounded-lg hover:bg-red-700 transition shadow-md">Search</button>
            </div>
        </div>

        <div id="loadingSpinner" class="hidden text-center my-8">
            <svg class="animate-spin h-8 w-8 text-red-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            <p class="mt-2 text-gray-400">Searching...</p>
        </div>

        <div id="resultsContainer" class="space-y-4"></div>

        <div id="detailContainer" class="hidden mt-8 bg-gray-800 border border-gray-700 p-6 rounded-xl shadow-lg">
            <button id="backButton" class="mb-4 text-red-500 font-semibold hover:underline">&larr; Back to search
                results</button>
            <div id="politicianDetails" class="text-center border-b border-gray-700 pb-4 mb-4"></div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-6">
                <div>
                    <h3 id="donationChartTitle" class="text-xl font-semibold mb-4 text-center text-white">Donation
                        Summary</h3>
                    <div id="donationSpinner" class="hidden text-center py-8">
                        <svg class="animate-spin h-6 w-6 text-red-500 mx-auto" xmlns="http://www.w3.org/2000/svg"
                            fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                    </div>
                    <div class="chart-container">
                        <canvas id="donationChart"></canvas>
                    </div>
                    <div id="donationLegend" class="mt-4 text-sm space-y-2"></div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-center text-white leading-tight">
                        Voting Record on Enacted Bills <br>
                        <span class="text-lg font-normal text-gray-400">(since 108th Congress)</span>
                    </h3>

                    <div id="voteFilterControls" class="mb-4 p-2 bg-gray-700/50 rounded-lg">
                        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 text-sm">

                            <div class="relative" data-dropdown="billType">
                                <button
                                    class="dropdown-toggle bg-gray-600 text-white px-3 py-2 rounded-md flex items-center justify-between w-26"
                                    type="button">
                                    <span>Bill Types</span>
                                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div
                                    class="dropdown-menu hidden absolute z-10 w-48 bg-gray-800 border border-gray-700 rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto">
                                    <label
                                        class="flex items-center px-3 py-2 text-gray-200 hover:bg-gray-700 cursor-pointer">
                                        <input type="checkbox"
                                            class="form-checkbox h-4 w-4 text-red-600 bg-gray-700 border-gray-600 rounded"
                                            value="hr" name="billType">
                                        <span class="ml-2 text-sm">HR (House Bill)</span>
                                    </label>
                                    <label
                                        class="flex items-center px-3 py-2 text-gray-200 hover:bg-gray-700 cursor-pointer">
                                        <input type="checkbox"
                                            class="form-checkbox h-4 w-4 text-red-600 bg-gray-700 border-gray-600 rounded"
                                            value="s" name="billType">
                                        <span class="ml-2 text-sm">S (Senate Bill)</span>
                                    </label>
                                    <label
                                        class="flex items-center px-3 py-2 text-gray-200 hover:bg-gray-700 cursor-pointer">
                                        <input type="checkbox"
                                            class="form-checkbox h-4 w-4 text-red-600 bg-gray-700 border-gray-600 rounded"
                                            value="hjres" name="billType">
                                        <span class="ml-2 text-sm">HJRes (House Joint)</span>
                                    </label>
                                    <label
                                        class="flex items-center px-3 py-2 text-gray-200 hover:bg-gray-700 cursor-pointer">
                                        <input type="checkbox"
                                            class="form-checkbox h-4 w-4 text-red-600 bg-gray-700 border-gray-600 rounded"
                                            value="sjres" name="billType">
                                        <span class="ml-2 text-sm">SJRes (Senate Joint)</span>
                                    </label>
                                </div>
                            </div>

                            <div class="relative" data-dropdown="billSubject">
                                <button
                                    class="dropdown-toggle bg-gray-600 text-white px-3 py-2 rounded-md flex items-center justify-between w-26"
                                    type="button">
                                    <span>Bill Subjects</span>
                                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div id="billSubjectDropdownMenu"
                                    class="dropdown-menu hidden absolute z-10 w-48 bg-gray-800 border border-gray-700 rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto">
                                </div>
                            </div>

                            <div class="flex items-center gap-2">
                                <label for="sortToggle" class="font-semibold">Sort:</label>
                                <select id="sortToggle"
                                    class="bg-gray-600 text-white rounded-md px-3 py-2 focus:outline-none text-sm">
                                    <option value="desc">Newest First</option>
                                    <option value="asc">Oldest First</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="voteSpinner" class="hidden text-center py-8">
                        <svg class="animate-spin h-6 w-6 text-red-500 mx-auto" xmlns="http://www.w3.org/2000/svg"
                            fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                    </div>
                    <div id="voteRecord" class="max-h-[28rem] lg:max-h-[448px] overflow-y-auto space-y-3 pr-2"></div>

                    <div id="votePagination" class="hidden flex items-center justify-between mt-4">
                        <button id="prevPageBtn"
                            class="pagination-btn bg-red-600 text-white font-semibold py-2 px-4 w-24 rounded-lg hover:bg-red-700 transition disabled:opacity-40 disabled:cursor-not-allowed">
                            Previous <br> &larr;
                        </button>
                        <span id="pageInfo" class="text-sm text-gray-400">Page 1 of 1</span>
                        <button id="nextPageBtn"
                            class="pagination-btn bg-red-600 text-white font-semibold py-2 px-4 w-24 rounded-lg hover:bg-red-700 transition disabled:opacity-40 disabled:cursor-not-allowed">
                            Next <br> &rarr;
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = "/api"; // Use relative path to local server



        /**
         * Populates a dropdown menu with checkboxes.
         */
        function createDropdownCheckboxes(containerId, items, groupName) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Clear
            items.forEach(item => {
                const label = document.createElement('label');
                label.className = 'flex items-center px-3 py-2 text-gray-200 hover:bg-gray-700 cursor-pointer';
                label.innerHTML = `
                    <input type="checkbox" class="form-checkbox h-4 w-4 text-red-600 bg-gray-700 border-gray-600 rounded" value="${item}" name="${groupName}">
                    <span class="ml-2 text-sm">${item}</span>
                `;
                container.appendChild(label);
            });
        }

        /**
         * Fetches the complete list of unique bill subjects from the API.
         */
        async function fetchAndPopulateSubjects() {
            try {
                const response = await fetch(`${API_BASE_URL}/bills/subjects`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const subjects = await response.json();
                if (Array.isArray(subjects)) {
                    // Populate the dropdown with the dynamically fetched list
                    createDropdownCheckboxes('billSubjectDropdownMenu', subjects.sort(), 'subject');
                } else {
                    console.error("Failed to load subjects: API did not return an array.");
                }
            } catch (error) {
                console.error("Failed to load bill subjects:", error);
                // Add a failure message to the dropdown
                document.getElementById('billSubjectDropdownMenu').innerHTML =
                    `<div class="px-3 py-2 text-red-400">Error loading subjects.</div>`;
            }
        }

        // Get DOM elements
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const resultsContainer = document.getElementById('resultsContainer');
        const detailContainer = document.getElementById('detailContainer');
        const backButton = document.getElementById('backButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const searchSection = document.getElementById('searchSection');
        const voteFilterControls = document.getElementById('voteFilterControls');
        const voteRecordDiv = document.getElementById('voteRecord');
        const voteSpinner = document.getElementById('voteSpinner');
        const politicianDetailsDiv = document.getElementById('politicianDetails');
        const donationLegendDiv = document.getElementById('donationLegend');
        const donationSpinner = document.getElementById('donationSpinner');
        const donationChartCanvas = document.getElementById('donationChart');
        const donationTitleElement = document.getElementById('donationChartTitle');
        // Pagination elements
        const votePagination = document.getElementById('votePagination');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const pageInfo = document.getElementById('pageInfo');

        let donationChartInstance = null;
        let searchResultsCache = [];
        let currentPoliticianId = null;
        let currentPage = 1;
        let totalPages = 1;

        /**
         * Searches for politicians based on the input field.
         */
        async function searchPoliticians() {
            const query = searchInput.value.trim();
            if (query.length < 2) {
                resultsContainer.innerHTML = '<p class="text-center text-gray-400">Please enter at least 2 characters to search.</p>';
                return;
            }
            resultsContainer.innerHTML = '';
            loadingSpinner.classList.remove('hidden');
            detailContainer.classList.add('hidden');
            try {
                const response = await fetch(`${API_BASE_URL}/politicians/search?name=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                searchResultsCache = await response.json();
                searchResultsCache = searchResultsCache.map(p => {
                    const lowerCasePolitician = {};
                    for (const key in p) {
                        lowerCasePolitician[key.toLowerCase()] = p[key];
                    }
                    return lowerCasePolitician;
                });
                displaySearchResults(searchResultsCache);
            } catch (error) {
                console.error("Search failed:", error);
                resultsContainer.innerHTML = `<p class="text-center text-red-500">Search failed. Is the API server running?</p>`;
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        /**
         * Displays the list of politician search results.
         */
        function displaySearchResults(politicians) {
            resultsContainer.innerHTML = '';
            if (politicians.length === 0) {
                resultsContainer.innerHTML = '<p class="text-center text-gray-400">No results found.</p>';
                return;
            }
            politicians.forEach(p => {
                const card = document.createElement('div');
                card.className = 'bg-gray-700 p-4 rounded-lg shadow-md cursor-pointer hover:shadow-lg hover:bg-gray-600 transition';
                card.setAttribute('data-id', p.politicianid);
                card.innerHTML = `
                    <h3 class="text-lg font-semibold text-red-500">${p.firstname} ${p.lastname}</h3>
                    <p class="text-gray-300">${p.party} - ${p.state} ${p.role ? `(${p.role})` : ''}</p>
                    <p class="text-sm ${p.isactive ? 'text-green-400' : 'text-gray-400'}">${p.isactive ? 'Currently Active' : 'Inactive'}</p>
                `;
                card.addEventListener('click', () => showDetails(p.politicianid));
                resultsContainer.appendChild(card);
            });
        }

        /**
         * Shows the detailed view for a specific politician.
         */
        async function showDetails(politicianId) {
            currentPoliticianId = politicianId;
            searchSection.classList.add('hidden');
            resultsContainer.classList.add('hidden');
            loadingSpinner.classList.add('hidden');
            detailContainer.classList.remove('hidden');
            document.getElementById('sortToggle').value = 'desc';
            document.querySelectorAll('#voteFilterControls input[type="checkbox"]').forEach(cb => cb.checked = false);

            currentPage = 1;
            totalPages = 1;
            politicianDetailsDiv.innerHTML = '';
            voteRecordDiv.innerHTML = '';
            donationLegendDiv.innerHTML = '';
            votePagination.classList.add('hidden');
            if (donationChartInstance) donationChartInstance.destroy();
            donationSpinner.classList.remove('hidden');

            const details = searchResultsCache.find(p => p.politicianid === politicianId);
            if (details) {
                politicianDetailsDiv.innerHTML = `
                    <h2 class="text-3xl font-bold text-white">${details.firstname} ${details.lastname}</h2>
                    <p class="text-lg text-gray-400">${details.party} - ${details.state} ${details.role ? `(${details.role})` : ''}</p>
                `;
            } else {
                politicianDetailsDiv.innerHTML = `<p class="text-center text-red-400">Could not load politician details.</p>`;
            }

            fetchAndDisplayVotes(1);
            fetchAndDisplayDonations(politicianId);
        }

        /**
         * Fetches vote data based on current page, filter, and sort.
         */
        async function fetchAndDisplayVotes(page = 1) {
            if (!currentPoliticianId) return;
            voteSpinner.classList.remove('hidden');
            voteRecordDiv.innerHTML = '';
            votePagination.classList.add('hidden');
            currentPage = page;

            try {
                const sortOrder = document.getElementById('sortToggle').value;
                const typeCheckboxes = document.querySelectorAll('[data-dropdown="billType"] input[type="checkbox"]:checked');
                const types = Array.from(typeCheckboxes).map(cb => cb.value);
                const subjectCheckboxes = document.querySelectorAll('[data-dropdown="billSubject"] input[type="checkbox"]:checked');
                const subjects = Array.from(subjectCheckboxes).map(cb => cb.value);

                let voteApiUrl = `${API_BASE_URL}/politician/${currentPoliticianId}/votes?page=${page}&sort=${sortOrder}`;
                types.forEach(type => { voteApiUrl += `&type=${encodeURIComponent(type)}`; });
                subjects.forEach(subject => { voteApiUrl += `&subject=${encodeURIComponent(subject)}`; });

                const votesRes = await fetch(voteApiUrl);
                if (!votesRes.ok) throw new Error(`Failed to fetch voting record (${votesRes.status})`);

                const data = await votesRes.json();
                const votes = data.votes;
                const pagination = data.pagination;
                const lowerCaseVotes = votes.map(v => {
                    const lowerCaseVote = {};
                    for (const key in v) { lowerCaseVote[key.toLowerCase()] = v[key]; }
                    return lowerCaseVote;
                });
                displayVotes(lowerCaseVotes);
                updateVotePagination(pagination);
            } catch (error) {
                console.error("Failed to load votes:", error);
                voteRecordDiv.innerHTML = `<p class="text-center text-red-400 font-semibold">Could not load votes: ${error.message}</p>`;
            } finally {
                voteSpinner.classList.add('hidden');
            }
        }

        /**
         * Renders the list of votes, including clickable subject tags.
         */
        function displayVotes(votes) {
            voteRecordDiv.innerHTML = '';
            if (!votes || votes.length === 0) {
                voteRecordDiv.innerHTML = '<p class="text-gray-400 text-center">No voting record found for this filter.</p>';
                return;
            }
            votes.forEach(v => {
                const voteColor = v.vote === 'Yea' ? 'text-green-400' : (v.vote === 'Nay' ? 'text-red-400' : 'text-gray-400');
                const voteItem = document.createElement('div');
                voteItem.className = 'border-t border-gray-700 pt-3 pb-1';

                let dateString = 'N/A';
                if (v.dateintroduced) {
                    try {
                        const dateObj = new Date(v.dateintroduced);
                        if (!isNaN(dateObj.getTime())) {
                            dateString = dateObj.toLocaleDateString('en-US', {
                                year: 'numeric', month: 'short', day: 'numeric', timeZone: 'UTC'
                            });
                        } else { console.warn("Could not parse date (isNan):", v.dateintroduced); }
                    } catch (e) { console.warn("Could not parse date (catch):", v.dateintroduced); }
                }

                let subjectsHTML = '';
                if (Array.isArray(v.subjects) && v.subjects.length > 0) {
                    subjectsHTML = '<div class="mt-1 flex flex-wrap gap-1 subject-tags">';
                    v.subjects.forEach(subject => {
                        if (subject && subject.trim()) {
                            subjectsHTML += `<span class="subject-tag cursor-pointer text-xs bg-gray-600 hover:bg-red-700 text-gray-200 px-2 py-0.5 rounded-full transition" data-subject="${subject.trim()}">${subject.trim()}</span>`;
                        }
                    });
                    subjectsHTML += '</div>';
                }

                voteItem.innerHTML = `
                    <p class="font-semibold text-gray-200">${v.billnumber}: ${v.title || 'Title not available'}</p>
                    <p class="text-sm text-gray-500">Introduced: ${dateString}</p>
                    <p class="text-sm">Vote: <span class="font-bold ${voteColor}">${v.vote}</span></p>
                    ${subjectsHTML} `;
                voteRecordDiv.appendChild(voteItem);
            });
        }

        /**
         * Updates the pagination controls based on API response.
         */
        /**
         * Updates the pagination controls based on API response.
         */
        function updateVotePagination(pagination) {
            // Check if pagination data exists and if there's more than one page
            if (!pagination || pagination.totalPages <= 1) { // CORRECTED: totalPages
                votePagination.classList.add('hidden');
                return;
            }
            // Use camelCase keys from the API response
            totalPages = pagination.totalPages;     // CORRECTED: totalPages
            currentPage = pagination.currentPage;   // CORRECTED: currentPage

            // Update the display text
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

            // Enable/disable buttons based on the current page
            prevPageBtn.disabled = (currentPage <= 1);
            nextPageBtn.disabled = (currentPage >= totalPages);

            // Show the pagination controls
            votePagination.classList.remove('hidden');
        }

        /**
         * Renders the donation pie chart and legend.
         */
        function displayDonations(donations, subject = null) {
            const ctx = donationChartCanvas.getContext('2d');
            donationLegendDiv.innerHTML = '';
            if (donationChartInstance) donationChartInstance.destroy();

            if (donationTitleElement) {
                donationTitleElement.innerHTML = subject
                    ? `Donation Summary <span class="text-sm text-gray-400 font-normal">(Filtered by: ${subject})</span>`
                    : `Donation Summary`;
            }

            if (!donations || donations.length === 0) {
                const message = subject ? `No donation data found for topic: ${subject}.` : `No donation data found > $2000.`;
                donationLegendDiv.innerHTML = `<p class="text-gray-400 text-center">${message}</p>`;
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                return;
            }

            const maxSlices = 10;
            const mainDonations = donations.slice(0, maxSlices);
            if (donations.length > maxSlices) {
                const otherSlice = donations.slice(maxSlices).reduce((acc, d) => {
                    acc.totalamount += Number(d.totalamount || 0); return acc;
                }, { totalamount: 0 });
                mainDonations.push({
                    industry: `Other (${donations.length - maxSlices} industries)`,
                    totalamount: otherSlice.totalamount,
                });
            }

            const labels = mainDonations.map(d => d.industry || d.donorname);
            const data = mainDonations.map(d => Number(d.totalamount || 0));
            const total = data.reduce((a, b) => a + b, 0);

            const backgroundColors = ['#D9272E', '#F97316', '#F59E0B', '#84CC16', '#10B981', '#14B8A6', '#06B6D4', '#3B82F6', '#6366F1', '#8B5CF6', '#6B7280'];
            Chart.defaults.color = '#E5E7EB';
            Chart.defaults.borderColor = '#374151';

            donationChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels, datasets: [{
                        label: 'Donation Amount', data: data,
                        backgroundColor: backgroundColors.slice(0, data.length),
                        borderColor: '#1F2937', borderWidth: 3
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.label || ''; if (label) { label += ': '; }
                                    let value = context.parsed;
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
                                    return label;
                                }
                            }
                        }
                    }, cutout: '60%'
                }
            });

            mainDonations.forEach((d, index) => {
                const percentage = total > 0 ? (Number(d.totalamount) / total) * 100 : 0;
                const legendItem = document.createElement('div');
                const displayName = d.industry || d.donorname;
                legendItem.className = 'flex items-center justify-between';
                legendItem.innerHTML = `
                    <div class="flex items-center overflow-hidden mr-2">
                        <span class="w-4 h-4 rounded-full mr-2 flex-shrink-0" style="background-color: ${backgroundColors[index % backgroundColors.length]}"></span>
                        <span class="text-gray-300 truncate" title="${displayName}">${displayName}</span>
                    </div>
                    <span class="font-semibold text-gray-200 flex-shrink-0">${percentage.toFixed(2)}%</span>`;
                donationLegendDiv.appendChild(legendItem);
            });
        }

        /**
         * Fetches and displays the UNFILTERED donation summary.
         */
        async function fetchAndDisplayDonations(politicianId) {
            if (!politicianId) return;
            console.log("Fetching ALL donations");
            donationSpinner.classList.remove('hidden');
            if (donationChartInstance) donationChartInstance.destroy();
            donationLegendDiv.innerHTML = '';

            try {
                const donationsRes = await fetch(`${API_BASE_URL}/politician/${politicianId}/donations/summary`);
                if (!donationsRes.ok) throw new Error(`Failed to fetch donation summary (${donationsRes.status})`);
                const donations = await donationsRes.json();
                displayDonations(donations, null);
            } catch (error) {
                console.error("Failed to load donations:", error);
                donationLegendDiv.innerHTML = `<p class="text-center text-red-400 font-semibold">Could not load donations: ${error.message}</p>`;
                if (donationTitleElement) { donationTitleElement.innerHTML = `Donation Summary`; }
            } finally { donationSpinner.classList.add('hidden'); }
        }

        /**
         * Fetches and displays donation summary filtered by a bill subject.
         */
        async function filterDonationsBySubject(subject) {
            if (!currentPoliticianId || !subject) return;
            console.log(`Fetching filtered donations for subject: ${subject}`);
            donationSpinner.classList.remove('hidden');
            if (donationChartInstance) donationChartInstance.destroy();
            donationLegendDiv.innerHTML = `<p class="text-center text-gray-400">Filtering donors for topic: ${subject}...</p>`;
            try {
                const encodedSubject = encodeURIComponent(subject);
                const response = await fetch(`${API_BASE_URL}/politician/${currentPoliticianId}/donations/summary/filtered?topic=${encodedSubject}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown API error' }));
                    throw new Error(`API Error (${response.status}): ${errorData.error || 'Failed to fetch filtered donations'}`);
                }
                const filteredDonations = await response.json();
                displayDonations(filteredDonations, subject);
            } catch (error) {
                console.error("Failed to load filtered donations:", error);
                donationLegendDiv.innerHTML = `<p class="text-center text-red-400 font-semibold">Could not load filtered donations: ${error.message}</p>`;
                if (donationTitleElement) { donationTitleElement.innerHTML = `Donation Summary`; }
            } finally { donationSpinner.classList.add('hidden'); }
        }

        /**
         * Hides the detail view and shows the search results.
         */
        function showSearchResults() {
            detailContainer.classList.add('hidden');
            searchSection.classList.remove('hidden');
            resultsContainer.classList.remove('hidden');
            searchInput.focus(); searchInput.select(); currentPoliticianId = null;
        }

        // --- EVENT LISTENERS ---
        searchButton.addEventListener('click', searchPoliticians);
        searchInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') searchPoliticians(); });
        backButton.addEventListener('click', showSearchResults);
        voteFilterControls.addEventListener('change', () => { fetchAndDisplayVotes(1); });
        prevPageBtn.addEventListener('click', () => { if (currentPage > 1) { fetchAndDisplayVotes(currentPage - 1); } });
        nextPageBtn.addEventListener('click', () => { if (currentPage < totalPages) { fetchAndDisplayVotes(currentPage + 1); } });

        // Listener for Subject Tags (with deselect)
        voteRecordDiv.addEventListener('click', function (event) {
            const tag = event.target.closest('.subject-tag');
            if (tag) {
                const subject = tag.getAttribute('data-subject');
                if (tag.classList.contains('bg-red-700')) {
                    console.log("Deselecting subject:", subject);
                    fetchAndDisplayDonations(currentPoliticianId);
                    document.querySelectorAll('.subject-tag').forEach(t => {
                        t.classList.remove('bg-red-700', 'font-semibold'); t.classList.add('bg-gray-600');
                    });
                } else {
                    console.log("Subject tag clicked:", subject);
                    filterDonationsBySubject(subject);
                    document.querySelectorAll('.subject-tag').forEach(t => {
                        t.classList.remove('bg-red-700', 'font-semibold'); t.classList.add('bg-gray-600');
                    });
                    tag.classList.add('bg-red-700', 'font-semibold'); tag.classList.remove('bg-gray-600');
                }
            }
        });

        // Listener to Clear Filter (clicking the donation title)
        if (donationTitleElement) {
            donationTitleElement.classList.add('cursor-pointer');
            donationTitleElement.setAttribute('title', 'Click to show all donors');
            donationTitleElement.addEventListener('click', () => {
                if (donationTitleElement.innerHTML.includes("Filtered by")) {
                    console.log("Clearing donation filter.");
                    fetchAndDisplayDonations(currentPoliticianId);
                    document.querySelectorAll('.subject-tag').forEach(t => {
                        t.classList.remove('bg-red-700', 'font-semibold'); t.classList.add('bg-gray-600');
                    });
                }
            });
        }

        // --- Setup for new dropdown filters ---

        fetchAndPopulateSubjects(); // Load subjects dynamically
        document.querySelectorAll('.dropdown-toggle').forEach(button => {
            button.addEventListener('click', (e) => {
                const dropdown = button.closest('[data-dropdown]');
                const menu = dropdown.querySelector('.dropdown-menu');
                // Close other open dropdowns first
                document.querySelectorAll('.dropdown-menu').forEach(otherMenu => {
                    if (otherMenu !== menu && !otherMenu.classList.contains('hidden')) {
                        otherMenu.classList.add('hidden');
                    }
                });
                menu.classList.toggle('hidden');
                e.stopPropagation();
            });
        });
        window.addEventListener('click', (e) => {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                if (!menu.classList.contains('hidden') && !menu.closest('[data-dropdown]').contains(e.target)) {
                    menu.classList.add('hidden');
                }
            });
        });
        // --- END Setup for new dropdown filters ---
    </script>
</body>


</html>
